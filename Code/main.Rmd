---
title: "**Seroprevalence Project**"
author: 
  - "Franky Zhang"
  - "Supervisor: Jo Youngji"
date: "`r Sys.Date()`"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(lubridate)
# list.files()
```

# ----------------------------
# Load and Process the dataset (NO need to be run)
# ----------------------------

```{r}
rm(list = ls())
url_S_12 <- "../data/datashare_240902/df_S1S2_240827.xlsx"

S_12 <- readxl::read_excel(url_S_12) %>%
  # Select relevant columns
  dplyr::select(
    starts_with("GNO"), sex, starts_with("age"),
    starts_with("wgt"), 
    starts_with("N_"), starts_with("S_"),
    starts_with("vax"), starts_with("conf"),
    starts_with("collect"), starts_with("p21_q2"),
    "q2_S2", "p21_q4_S1", "q6_S2", "q9_3_S2", 
    "p11_q1_S1", "p11_q3_2_S1", "p21_q1_S1", "p21_q3_1_S1", "p21_q3_2_S1"
  ) %>%
  # Rename columns for clarity
  dplyr::rename(
    hypertension1        = "p21_q2_1_S1",
    diabetes1            = "p21_q2_2_S1",
    highcol1             = "p21_q2_3_S1",
    cancer1              = "p21_q2_4_S1",
    brainblood1          = "p21_q2_5_S1",
    chronickidney1       = "p21_q2_6_S1",
    chroniclung1         = "p21_q2_7_S1",
    liver1               = "p21_q2_8_S1",
    immunocomp1          = "p21_q2_9_S1",
    rumatis1             = "p21_q2_10_S1",
    other1               = "p21_q2_91_S1",
    otherdisease_S2_raw  = "q2_S2",
    sym_S1_raw           = "p21_q4_S1",
    sym_S2_raw           = "q6_S2",
    vax.date5            = "vax.date.bi",
    hosp.S2              = "q9_3_S2", 
    household_type       = "p11_q1_S1", 
    income               = "p11_q3_2_S1", 
    health_status        = "p21_q1_S1", 
    height               = "p21_q3_1_S1", 
    weight               = "p21_q3_2_S1"
  ) %>%
  # Create new variables for disease status and symptoms
  dplyr::mutate(
    otherdisease_S1 = if_else(
      hypertension1 == 1 & diabetes1 == 1 & highcol1 == 1 & cancer1 == 1 &
        brainblood1 == 1 & chronickidney1 == 1 & chroniclung1 == 1 &
        liver1 == 1 & immunocomp1 == 1 & rumatis1 == 1 & other1 == 1,
      "no", "yes"
    ),
    otherdisease_S2 = if_else(otherdisease_S2_raw == 2, "no", "yes"),
    sym_S1 = case_when(
      sym_S1_raw == 1 ~ "no",
      sym_S1_raw == 2 ~ "yes",
      TRUE ~ NA_character_
    ),
    sym_S2 = case_when(
      sym_S2_raw == 1 ~ "yes",
      sym_S2_raw == 2 ~ "no",
      TRUE ~ NA_character_
    ), 
    BMI = weight/((height/100)^2)
  ) %>%
  # Categorize groups based on S and N test results
  dplyr::mutate(
    group1 = case_when(
      grepl("Positive", S_cha_S1) & grepl("Reactive", N_cha_S1) ~ 1,  # S+N+ Inf(vac)
      grepl("Negative", S_cha_S1) & grepl("Reactive", N_cha_S1) ~ 2,  # S-N+ Inf
      grepl("Positive", S_cha_S1) & grepl("Nonreactive", N_cha_S1) ~ 3,  # S+N- Vac
      grepl("Negative", S_cha_S1) & grepl("Nonreactive", N_cha_S1) ~ 4,  # S-N- Naive
      TRUE ~ 0
    ),
    group2 = case_when(
      grepl("Positive", S_cha_S2) & grepl("Reactive", N_cha_S2) ~ 1,  # S+N+ Inf(vac)
      grepl("Negative", S_cha_S2) & grepl("Reactive", N_cha_S2) ~ 2,  # S-N+ Inf
      grepl("Positive", S_cha_S2) & grepl("Nonreactive", N_cha_S2) ~ 3,  # S+N- Vac
      grepl("Negative", S_cha_S2) & grepl("Nonreactive", N_cha_S2) ~ 4,  # S-N- Naive
      TRUE ~ 0
    )
  ) %>%
  # Categorize groups as "inf", "vac", or "naive"
  dplyr::mutate(
    group11 = case_when(
      group1 %in% c(1, 2) ~ "inf",
      group1 == 3 ~ "vac",
      group1 == 4 ~ "naive",
      TRUE ~ NA_character_
    ),
    group22 = case_when(
      group2 %in% c(1, 2) ~ "inf",
      group2 == 3 ~ "vac",
      group2 == 4 ~ "naive",
      TRUE ~ NA_character_
    )
  )

# create new column: number of diseases by 1st Seroprevalence
S_12 <- S_12 %>%
  mutate(
    num_diseases_S1 = rowSums(
      cbind(hypertension1, diabetes1, highcol1, cancer1, brainblood1, chronickidney1, chroniclung1, 
              liver1, immunocomp1, rumatis1, other1 == 1) == 2,  
      na.rm = TRUE
    )
  )

# Convert date columns
convert_to_date <- function(date_col) {
  substr(date_col, 1, 10) %>%
    as.Date(format = "%Y-%m-%d")
}

# Apply date conversion for vaccination and confirmation dates
S_12 <- S_12 %>%
  dplyr::mutate(
    vax.date1 = convert_to_date(vax.date1),
    vax.date2 = convert_to_date(vax.date2),
    vax.date3 = convert_to_date(vax.date3),
    vax.date4 = convert_to_date(vax.date4),
    vax.date5 = convert_to_date(vax.date5),
    conf_date1 = convert_to_date(conf_date1),
    conf_date2 = convert_to_date(conf_date2),
    conf_date3 = convert_to_date(conf_date3),
    collect_date_S2 = convert_to_date(collect_time_S2),
    collect_date_S1 = as.Date(collect_date_S1, format = "%Y-%m-%d")
  )

# Fill missing collection dates with the mode
most_common_date <- names(which.max(table(S_12$collect_date_S2))) %>% as.Date()
S_12$collect_date_S2[is.na(S_12$collect_date_S2)] <- most_common_date

# Function to find nearest date before a reference date
nearest_date_before <- function(ref_date, ...){
  dates <- na.omit(c(...))
  dates <- dates[dates < ref_date]
  if(length(dates) == 0) return(NA)
  return(max(dates))
}

# Function to find the nearest date after a reference date
nearest_date_after <- function(ref_date, ...) {
  dates <- na.omit(c(...))
  dates <- dates[dates > ref_date]
  if (length(dates) == 0) return(NA)
  return(min(dates))
}

# Calculate nearest dates
S_12 <- S_12 %>%
  rowwise() %>%
  mutate(
    nearest_confirmed_before_S1 = nearest_date_before(collect_date_S1, conf_date1, conf_date2, conf_date3),
    nearest_confirmed_before_S2 = nearest_date_before(collect_date_S2, conf_date1, conf_date2, conf_date3),
    nearest_confirmed_after_S1 = nearest_date_after(collect_date_S1, conf_date1, conf_date2, conf_date3)
  ) %>%
  ungroup()

# Calculate infection and survey gaps
S_12 <- S_12 %>%
  mutate(
    gap_between_surveys = as.integer(collect_date_S2 - collect_date_S1),
    infec_gap_after_S1 = as.integer(nearest_confirmed_after_S1 - collect_date_S1),
    infec_gap_before_S1 = as.integer(collect_date_S1 - nearest_confirmed_before_S1),
    infec_gap_before_S2 = as.integer(collect_date_S2 - nearest_confirmed_before_S2),
    between_S1_S2_infec_cat = case_when(
      is.na(collect_date_S2) ~ NA_character_,
      is.na(infec_gap_after_S1) ~ "no",
      !is.na(infec_gap_after_S1) & infec_gap_after_S1 <= gap_between_surveys ~ "yes",
      TRUE ~ "no"
    )
  )

# Calculate nearest vaccination dates
S_12 <- S_12 %>%
  rowwise() %>%
  mutate(
    nearest_vac_before_S1 = nearest_date_before(collect_date_S1, vax.date1, vax.date2, vax.date3, vax.date4, vax.date5),
    nearest_vac_before_S2 = nearest_date_before(collect_date_S2, vax.date1, vax.date2, vax.date3, vax.date4, vax.date5),
    nearest_vac_after_S1 = nearest_date_after(collect_date_S1, vax.date1, vax.date2, vax.date3, vax.date4, vax.date5)
  ) %>%
  ungroup()

# Calculate vaccination gaps
S_12 <- S_12 %>%
  mutate(
    vac_gap_after_S1 = as.integer(nearest_vac_after_S1 - collect_date_S1),
    vac_gap_before_S1 = as.integer(collect_date_S1 - nearest_vac_before_S1),
    vac_gap_before_S2 = as.integer(collect_date_S2 - nearest_vac_before_S2),
    between_S1_S2_vac_cat = case_when(
      is.na(collect_date_S2) ~ NA_character_,
      is.na(vac_gap_before_S2) ~ "no",
      vac_gap_before_S1 > 0 & is.na(vac_gap_after_S1) ~ "no",
      vac_gap_after_S1 <= gap_between_surveys ~ "yes",
      TRUE ~ "no"
    )
  )

# Calculate vaccination frequency
S_12 <- S_12 %>%
  rowwise() %>%
  mutate(
    vac_before_S1_freq = sum(c(vax.date1, vax.date2, vax.date3, vax.date4, vax.date5) < collect_date_S1, na.rm = TRUE)
  ) %>%
  ungroup()

# Clean numeric columns
S_12 <- S_12 %>%
  mutate(
    S_num_S1 = gsub("[<>]", "", S_num_S1) %>% as.numeric(),
    N_num_S1 = gsub("[<>]", "", N_num_S1) %>% as.numeric(),
    S_num_S2 = gsub("[<>]", "", S_num_S2) %>% as.numeric(),
    N_num_S2 = gsub("[<>]", "", N_num_S2) %>% as.numeric()
  )
```

# ----------------------------
# Generate Cohort (NO need to be run)
# ----------------------------

```{r}
# categorize the immune status based S and N antibody activity
S_12 <- S_12 %>%
  mutate(
    immune_type = case_when(
      group1 == 4 ~ "naive",
      group1 == 3 ~ "vac-induced",
      group1 == 2 ~ "inf-induced",
      group1 == 1 ~ "hybrid-induced",
      TRUE ~ NA_character_
    )
  )

S_12$immune_type <- factor(S_12$immune_type,
                           levels = c("hybrid-induced", "vac-induced", "inf-induced", "naive"))

# table(S_12$immune_type)


# *----------------------------------------------------------------------------*
# Inclusive cohort
# hybrid without vaccination record --> infection only induced
S_12.hybrid <- S_12 %>%
  filter(immune_type == "hybrid-induced", vac_before_S1_freq > 0) %>% 
  mutate(N_2nd_Survey = ifelse(between_S1_S2_vac_cat == "yes", "vac", 
                               ifelse(is.na(N_cha_S2), "follow_up_loss", 
                                      ifelse(N_num_S2 >  N_num_S1, "infection", "non_infection"))))
# table(S_12.hybrid$N_2nd_Survey)
# S_12.hybrid %>% filter(N_2nd_Survey == "vac") %>% filter(!is.na(N_num_S2)) %>% filter(N_num_S2 <= N_num_S1)

# vaccine without vaccination record --> infection only induced
S_12.vac <- S_12 %>%
  filter(immune_type == "vac-induced", vac_before_S1_freq > 0) %>% 
  mutate(N_2nd_Survey = ifelse(between_S1_S2_vac_cat == "yes", "vac", 
                               ifelse(is.na(N_cha_S2), "follow_up_loss", 
                                      ifelse(N_cha_S2 == "Reactive", "infection", "non_infection"))))
# table(S_12.vac$N_2nd_Survey)
# S_12.vac %>% filter(N_2nd_Survey == "vac") %>% filter(!is.na(N_num_S2)) %>% filter(N_cha_S2 == "Nonreactive")

S_12.inf <- S_12 %>%
  filter(immune_type == "inf-induced" | 
         (immune_type == "hybrid-induced" & vac_before_S1_freq == 0) | 
         (immune_type == "vac-induced" & vac_before_S1_freq == 0 )) %>% 
  mutate(N_2nd_Survey = ifelse(between_S1_S2_vac_cat == "yes", "vac", 
                               ifelse(is.na(N_cha_S2), "follow_up_loss", 
                                      ifelse(N_num_S2 >  N_num_S1, "infection", "non_infection"))))
# table(S_12.inf$N_2nd_Survey)

df <- S_12.hybrid %>% dplyr::filter(N_2nd_Survey == "follow_up_loss")
df1 <- S_12.hybrid %>% dplyr::filter(N_2nd_Survey != "follow_up_loss")
(df$agebase_cat2 %>% table())/dim(df)[1] %>% round(2)
(df1$agebase_cat2 %>% table())/dim(df1)[1] %>% round(2)



# *----------------------------------------------------------------------------*
# Conservative cohort (hybrid)
S_12.hybrid <- S_12.hybrid %>% 
  mutate(KDCA = ifelse(
    between_S1_S2_infec_cat == "yes", 
    "infection", 
    ifelse(N_2nd_Survey == "follow_up_loss", "follow_up_loss", "non_infection")
  ))

S_12.hybrid$KDCA <- ifelse(
  S_12.hybrid$KDCA == "infection" & 
  !is.na(S_12.hybrid$vac_gap_after_S1) & 
    !is.na(S_12.hybrid$vac_gap_after_S1) &
    S_12.hybrid$vac_gap_after_S1 < S_12.hybrid$infec_gap_after_S1, NA, S_12.hybrid$KDCA)

S_12.hybrid$KDCA <- ifelse(
  S_12.hybrid$KDCA == "non_infection" & S_12.hybrid$N_2nd_Survey == "vac", NA, S_12.hybrid$KDCA
)

S_12.hybrid$KDCA <- ifelse(S_12.hybrid$N_2nd_Survey == "follow_up_loss" & 
                             S_12.hybrid$KDCA == "follow_up_loss", "non_infection", S_12.hybrid$KDCA)


# Conservative cohort (vac)
S_12.vac <- S_12.vac %>% 
  mutate(KDCA = ifelse(
    between_S1_S2_infec_cat == "yes", 
    "infection", 
    ifelse(N_2nd_Survey == "follow_up_loss", "follow_up_loss", "non_infection")
  ))

S_12.vac$KDCA <- ifelse(
  S_12.vac$KDCA == "infection" & 
  !is.na(S_12.vac$vac_gap_after_S1) & 
    !is.na(S_12.vac$vac_gap_after_S1) &
    S_12.vac$vac_gap_after_S1 < S_12.vac$infec_gap_after_S1, NA, S_12.vac$KDCA)

S_12.vac$KDCA <- ifelse(
  S_12.vac$KDCA == "non_infection" & S_12.vac$N_2nd_Survey == "vac", NA, S_12.vac$KDCA
)

S_12.vac$KDCA <- ifelse(S_12.vac$N_2nd_Survey == "follow_up_loss" & 
                             S_12.vac$KDCA == "follow_up_loss", "non_infection", S_12.vac$KDCA)


# Conservative cohort (inf)
S_12.inf <- S_12.inf %>% 
  mutate(KDCA = ifelse(
    between_S1_S2_infec_cat == "yes", 
    "infection", 
    ifelse(N_2nd_Survey == "follow_up_loss", "follow_up_loss", "non_infection")
  ))

S_12.inf$KDCA <- ifelse(
  S_12.inf$KDCA == "infection" & 
  !is.na(S_12.inf$vac_gap_after_S1) & 
    !is.na(S_12.inf$vac_gap_after_S1) &
    S_12.inf$vac_gap_after_S1 < S_12.inf$infec_gap_after_S1, NA, S_12.inf$KDCA)

S_12.inf$KDCA <- ifelse(
  S_12.inf$KDCA == "non_infection" & S_12.inf$N_2nd_Survey == "vac", NA, S_12.inf$KDCA
)

S_12.inf$KDCA <- ifelse(S_12.inf$N_2nd_Survey == "follow_up_loss" & 
                             S_12.inf$KDCA == "follow_up_loss", "non_infection", S_12.inf$KDCA)

S_12.hybrid$KDCA[is.na(S_12.hybrid$KDCA)] <- "none"
S_12.vac$KDCA[is.na(S_12.vac$KDCA)] <- "none"
S_12.inf$KDCA[is.na(S_12.inf$KDCA)] <- "none"


# save the processed data
# saveRDS(S_12.hybrid, "TempData/S_12.hybrid.rds")
# saveRDS(S_12.vac, "TempData/S_12.vac.rds")
# saveRDS(S_12.inf, "TempData/S_12.inf.rds")


# S_12.comb <- rbind(S_12.hybrid, S_12.vac)
# weighted_counts <- tapply(S_12.comb$wgt_1ag, S_12.comb$KDCA, sum, na.rm = TRUE)
# weighted_counts / sum(weighted_counts, na.rm = FALSE)
# 
# unweighted_counts <- table(S_12.vac$KDCA)
# unweighted_counts / sum(unweighted_counts)
```





# ----------------------------
# Do the survival analysis
# ----------------------------

# ----------------------------
# 1. K-M survival curves (weighted)

## generate the survival cohorts (NO need to be run)

```{r}
rm(list = ls())
# load processed data
url <- list(
  hybrid = "TempData/S_12.hybrid.rds", 
  vac = "TempData/S_12.vac.rds", 
  inf = "TempData/S_12.inf.rds"
)

hybrid <- readRDS(url$hybrid)
vac <- readRDS(url$vac)
inf <- readRDS(url$inf)


# calculate the latest immunology
vac <- vac %>%
  mutate(latest_immunology = ifelse(
    is.na(vac_gap_before_S1), infec_gap_before_S1,
      ifelse(is.na(infec_gap_before_S1), vac_gap_before_S1,
             pmin(vac_gap_before_S1, infec_gap_before_S1, na.rm = TRUE))), 
    infec_gap = infec_gap_after_S1)

hybrid <- hybrid %>%
  mutate(latest_immunology = ifelse(
    is.na(vac_gap_before_S1), infec_gap_before_S1,
      ifelse(is.na(infec_gap_before_S1), vac_gap_before_S1,
             pmin(vac_gap_before_S1, infec_gap_before_S1, na.rm = TRUE))), 
    infec_gap = infec_gap_after_S1)

inf <- inf %>%
  mutate(latest_immunology = ifelse(
    is.na(vac_gap_before_S1), infec_gap_before_S1,
      ifelse(is.na(infec_gap_before_S1), vac_gap_before_S1,
             pmin(vac_gap_before_S1, infec_gap_before_S1, na.rm = TRUE))), 
    infec_gap = infec_gap_after_S1)

# define the imputation function
impute_infec_gap <- function(df) {
  library(mice)
  
  # df = vac  # for test 
  
  df_inf <- df %>% filter(N_2nd_Survey == "infection") %>% 
    mutate(infec_gap = ifelse(infec_gap > gap_between_surveys, NA, infec_gap))
  df_noninf <- df %>% filter(N_2nd_Survey != "infection")
  
  df_inf_impute <- mice(
    df_inf %>% select(
      S_num_S1, 
      N_num_S1, 
      age_base, 
      sex, 
      latest_immunology, 
      infec_gap
      ), 
    method = "pmm", 
    m = 5, 
    maxit = 50
  )
  df_inf_full <- complete(df_inf_impute)
  df_inf$infec_gap <- df_inf_full$infec_gap
  df_noninf$infec_gap <- NA
  
  return(rbind(df_inf, df_noninf))
}

# apply the function to impute
vac_full = impute_infec_gap(vac)
hybrid_full = impute_infec_gap(hybrid)
inf_full = impute_infec_gap(inf)

# bind to get full dataset 
inf_full$immune_type <- "inf-induced"
data <- rbind(vac_full, hybrid_full, inf_full)

# categorize the latest immunology
data <- data %>%
  mutate(
    latest_immunology_cat = case_when(
      latest_immunology >= 0 & latest_immunology <= 30 ~ "<1 month",
      latest_immunology > 30 & latest_immunology <= 180 ~ "1-6 months",
      latest_immunology > 180 & latest_immunology <= 365 ~ "6-12 months",
      latest_immunology > 365 ~ ">1 year",
      TRUE ~ "no_event"
    ),
    latest_immunology_cat = factor(
      latest_immunology_cat,
      levels = c("<1 month", "1-6 months", "6-12 months", ">1 year", "no_event")
    )
  )


data_Nstatus <- data %>%
  dplyr::filter(N_2nd_Survey == "infection" | N_2nd_Survey == "non_infection") %>% 
  dplyr::mutate(
    time = ifelse(
      N_2nd_Survey == "infection",
      infec_gap,
      gap_between_surveys
    ),
    status = ifelse(N_2nd_Survey == "infection", 1, 0),
    age_category = case_when(
      age_base < 20 ~ "<20",
      age_base >= 20 & age_base <= 40 ~ "20-40",
      age_base > 40 & age_base <= 60 ~ "40-60",
      age_base > 60 ~ ">60"
    ), 
    time = time / 30, 
  ) %>% 
  dplyr::select(
    GNO, 
    wgt_1f, 
    wgt_1ag, 
    weight, 
    height,
    num_diseases_S1, 
    age_category, 
    sex, 
    immune_type, 
    latest_immunology, 
    latest_immunology_cat, 
    vac_before_S1_freq, 
    S_num_S1, 
    S_cha_S1,
    N_num_S1, 
    N_num_S2, 
    N_cha_S1, 
    N_cha_S2,
    between_S1_S2_infec_cat, 
    infec_gap_after_S1, 
    gap_between_surveys, 
    time, 
    status, 
    N_2nd_Survey
  )

data_KDCA <- data %>%
  dplyr::filter(KDCA == "infection" | KDCA == "non_infection") %>% 
  dplyr::mutate(
    time = ifelse(
      KDCA == "infection",
      infec_gap_after_S1,
      gap_between_surveys
    ),
    status = ifelse(KDCA == "infection", 1, 0),
    age_category = case_when(
      age_base < 20 ~ "<20",
      age_base >= 20 & age_base <= 40 ~ "20-40",
      age_base > 40 & age_base <= 60 ~ "40-60",
      age_base > 60 ~ ">60"
    ), 
    time = time / 30, 
  ) %>% 
  dplyr::select(
    GNO, 
    wgt_1f, 
    wgt_1ag,  
    weight, 
    height,
    num_diseases_S1, 
    age_category, 
    sex, 
    immune_type, 
    latest_immunology, 
    latest_immunology_cat, 
    vac_before_S1_freq, 
    S_num_S1, 
    S_num_S2,
    N_num_S1, 
    N_num_S2, 
    N_cha_S1, 
    N_cha_S2,
    between_S1_S2_infec_cat, 
    infec_gap_after_S1, 
    gap_between_surveys, 
    time, 
    status
  )
# 
# saveRDS(data_Nstatus, "TempData/data_Nstatus.rds")
# saveRDS(data_KDCA, "TempData/data_KDCA.rds")


# saveRDS(data, "TempData/summary_data.rds")


# ******************************************************************************
# calculate summary table
# input data
input_data <- data %>%
  dplyr::mutate(
    age_category = case_when(
      age_base < 20 ~ "<20",
      age_base >= 20 & age_base <= 40 ~ "20-40",
      age_base > 40 & age_base <= 60 ~ "40-60",
      age_base > 60 ~ ">60"
    )
  ) %>% 
  dplyr::select(
    GNO, 
    wgt_1f, 
    wgt_1ag,  
    weight, 
    height,
    N_2nd_Survey, 
    num_diseases_S1, 
    age_category, 
    sex, 
    immune_type, 
    latest_immunology, 
    latest_immunology_cat, 
    vac_before_S1_freq, 
    S_num_S1, 
    S_num_S2,
    N_num_S1, 
    N_num_S2, 
    between_S1_S2_infec_cat, 
    infec_gap_after_S1, 
    gap_between_surveys, KDCA
  )


# define the summary table function 
summary_table <- function(df, category = "age_category") {
  
  # Convert the category string to a symbol for tidy evaluation
  cat_sym <- sym(category)
  
  # Overall summary by the given category
  overall_table <- df %>%
    group_by(!!cat_sym) %>%
    summarise(
      count_overall = n(),
      total_wgt = sum(wgt_1ag, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(
      prop = round(count_overall / sum(count_overall) * 100, 1),
      wgt_prop = round(total_wgt / sum(total_wgt) * 100, 1)
    ) %>%
    select(!!cat_sym, count_overall, prop, wgt_prop)
  
  # Summary for "hybrid-induced"
  hybrid_table <- df %>%
    filter(immune_type == "hybrid-induced") %>%
    group_by(!!cat_sym) %>%
    summarise(
      count_hybrid = n(),
      total_wgt = sum(wgt_1ag, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(
      prop_hybrid = round(count_hybrid / sum(count_hybrid) * 100, 1),
      wgt_prop_hybrid = round(total_wgt / sum(total_wgt) * 100, 1)
    ) %>%
    select(!!cat_sym, count_hybrid, prop_hybrid, wgt_prop_hybrid)
  
  # Summary for "vac-induced"
  vac_table <- df %>%
    filter(immune_type == "vac-induced") %>%
    group_by(!!cat_sym) %>%
    summarise(
      count_vac = n(),
      total_wgt = sum(wgt_1ag, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(
      prop_vac = round(count_vac / sum(count_vac) * 100, 1),
      wgt_prop_vac = round(total_wgt / sum(total_wgt) * 100, 1)
    ) %>%
    select(!!cat_sym, count_vac, prop_vac, wgt_prop_vac)
  
  # Summary for "inf-induced"
  inf_table <- df %>%
    filter(immune_type == "inf-induced") %>%
    group_by(!!cat_sym) %>%
    summarise(
      count_inf = n(),
      total_wgt = sum(wgt_1ag, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(
      prop_inf = round(count_inf / sum(count_inf) * 100, 1),
      wgt_prop_inf = round(total_wgt / sum(total_wgt) * 100, 1)
    ) %>%
    select(!!cat_sym, count_inf, prop_inf, wgt_prop_inf)
  
  # Merge the overall and immune type-specific summaries by the category column.
  final_table <- overall_table %>%
    left_join(hybrid_table, by = category) %>%
    left_join(vac_table, by = category) %>% 
    left_join(inf_table, by = category)
  
  return(final_table)
}

# # for age_category
final_result <- summary_table(df = input_data, category = "age_category")
t <- final_result %>%
  arrange(factor(age_category, levels = c("<20", "20-40", "40-60", ">60")))

# # for sex
final_result <- summary_table(df = input_data, category = "sex")
t <- final_result %>%
  arrange(factor(sex, levels = c("Male", "Female")))

# # for BMI
input_data$BMI <-  input_data$weight/((input_data$height/100)^2)
input_data$BMI_cat <- cut(
  input_data$BMI,
  breaks = c(-Inf, 18.5, 24.9, Inf),
  labels = c("Low", "Normal", "Obesity"),
  include.lowest = TRUE
)

final_result <- summary_table(df = input_data, category = "BMI_cat")
t <- final_result %>%
  arrange(factor(BMI_cat, levels = c("Low", "Normal", "Obesity")))

# # for Diseases
input_data$cat_diseases_S1 <- ifelse(input_data$num_diseases_S1 == 0, "none",
                                          ifelse(input_data$num_diseases_S1 == 1, 1,
                                                 ifelse(input_data$num_diseases_S1 == 2, 2, ">=3")))

final_result <- summary_table(df = input_data, category = "cat_diseases_S1")
t <- final_result %>%
  arrange(factor(cat_diseases_S1, levels = c("none", "1", "2", ">=3")))

# # latest immunology
t <- summary_table(df = input_data, category = "latest_immunology_cat")

# vaccine dose
input_data$vac_dose <- ifelse(input_data$vac_before_S1_freq == 0, "no_vac", 
                              ifelse(input_data$vac_before_S1_freq < 3, "primary_dose", input_data$vac_before_S1_freq))
final_result <- summary_table(df = input_data, category = "vac_dose")
t <- final_result %>%
  arrange(factor(vac_dose, levels = c("no_vac", "primary_dose", "3", "4")))

# # between surveys status
t <- summary_table(df = input_data, category = "N_2nd_Survey")

t <- summary_table(df = input_data, category = "KDCA")

```

## do the survival analysis
## generate pic2 (a)(b) and pic 3(a)(b)
```{r}
# clean the environment
rm(list = ls())
url <- list(
  N_status = "TempData/data_Nstatus.rds", 
  KDCA = "TempData/data_KDCA.rds"
)

# load data
data_Nstatus <- readRDS(url$N_status)
data_KDCA <- readRDS(url$KDCA)

# table(data_Nstatus$immune_type, data_Nstatus$status)
# table(data_KDCA$immune_type, data_KDCA$status)


data_Nstatus$immune_type <- factor(
  data_Nstatus$immune_type,
  levels = c("hybrid-induced", "vac-induced", "inf-induced")
)

data_KDCA$immune_type <- factor(
  data_KDCA$immune_type,
  levels = c("hybrid-induced", "vac-induced", "inf-induced")
)

library(ggsurvfit)
library(survminer)
library(survival)
library(flexsurv)
library(grid)

# with immune_type only
fit <- survfit(Surv(time, status) ~ immune_type, 
               data = data_KDCA,
               # data = data_Nstatus,
               weights = wgt_1ag)

summary_fit <- summary(fit)

ci_data <- data.frame(
  time = summary_fit$time,
  strata = summary_fit$strata,
  survival = summary_fit$surv,
  lower_CI = summary_fit$lower,
  upper_CI = summary_fit$upper
)

# 颜色保持一致
hybrid_colors <- c("Hybrid" = "#0000FF")
vac_colors <- c("Vaccine" = "#DC143C")
inf_colors <- c("Infection" = "orange")
combined_colors <- c(hybrid_colors, vac_colors, inf_colors)

# ggsurvplot 主体
ggsurv <- ggsurvplot(
  fit = fit, 
  data = data_Nstatus,
  risk.table = TRUE,  
  risk.table.col = "strata", 
  risk.table.height = 0.25, 
  risk.table.y.text.col = TRUE, 
  risk.table.y.text = TRUE, 
  ncensor.plot = TRUE,
  ncensor.plot.height = 0.25, 
  pval = TRUE,
  conf.int = TRUE, 
  palette = combined_colors,
  legend.labs = c("Hybrid", "Vaccine", "Infection"),
  xlab = "Time (Months)", 
  ylab = "Estimated Log Hazard Ratio",  # 注意：这里可按语境改为 survival probability
  break.time.by = 1,
  ggtheme = theme_classic(base_size = 14, base_family = "serif") +
    theme(
      axis.line = element_line(color = "black", size = 0.6),
      panel.grid.major.y = element_line(color = "gray80", linetype = "dotted"),
      panel.grid.major.x = element_blank(),
      panel.border = element_blank(),
      legend.position = c(0.1, 0.9),
      legend.text = element_text(size = 11),
      legend.title = element_blank(),
      legend.key.size = unit(0.4, "cm"),
      legend.box.background = element_blank(),
      plot.margin = margin(5, 5, 5, 5)
    ),
  ylim = c(0.5, 1),
  xlim = c(0, 4.5)
)

# 主图优化（保持和plot_logHR_tt_cox一致）
p1 <- ggsurv$plot + 
  scale_color_manual(values = combined_colors) +
  theme(
    legend.position = c(0.06, 0.12),
    legend.text = element_text(size = 11),
    legend.title = element_blank(),
    legend.key.size = unit(0.6, "cm"),
    plot.margin = unit(c(0, 0, 0, 0), "mm")
  ) +
  guides(colour = guide_legend(
    nrow = 2, byrow = TRUE,
    title.position = "top",
    title.hjust = 0.5
  )) +
  ylab("Estimated Probability of Protection Against Infection") +
  xlab("Time (Months)")

# ggsave("../result/plots/fig2(11).png", plot = p1, width = 10, height = 7, dpi = 300)








# Define hazard table function (similar to age_risk_table)
age_hazard_table <- function(df, age_selection = "no") {
  age_categories <- c("<20", "20-40", "40-60", ">60")
  immune_types   <- c("hybrid-induced", "vac-induced")
  
  result_list <- list()
  
  for (imm in immune_types) {
    if (age_selection == "yes") {
      sub_list <- lapply(age_categories, function(age_cat) {
        df %>%
          filter(immune_type == imm, age_category == age_cat) %>%
          generate_survival_table(grid) %>%
          mutate(hazard = as.numeric(h),  # make sure it's numeric
                 age = age_cat,
                 immune = imm,
                 time = as.numeric(time)) %>%
          select(time, immune, age, hazard)
      })
      sub_df <- do.call(rbind, sub_list)
    } else {
      sub_df <- df %>%
        filter(immune_type == imm) %>%
        generate_survival_table(grid) %>%
        mutate(hazard = as.numeric(h),
               age = "all",
               immune = imm,
               time = as.numeric(time)) %>%
        select(time, immune, age, hazard)
    }
    result_list[[imm]] <- sub_df
  }
  
  hazard_df <- do.call(rbind, result_list)
  return(hazard_df)
}

hazard_df <- age_hazard_table(data_Nstatus, age_selection = "no")

# Plot hazard over time
library(ggplot2)

ggplot(hazard_df, aes(x = time, y = hazard, color = immune, group = immune)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(title = "Hazard Rates Over Time by Immune Type",
       x = "Time Interval (arbitrary units or months)",
       y = "Hazard Rate",
       color = "Immune Type") +
  scale_color_manual(values = c("hybrid-induced" = "blue", "vac-induced" = "red")) +
  theme_minimal()













# 
# hybrid_colors <- c(
#   "Hybrid <20" = "#ADD8E6",  # Light Blue
#   "Hybrid 20-39" = "#6495ED",  # Cornflower Blue
#   "Hybrid 40-59" = "#0000FF",  # Blue
#   "Hybrid >=60" = "#00008B"  # Dark Blue
# )
# 
# vac_colors <- c(
#   "Vac <20" = "#FFA07A",  # Light Salmon
#   "Vac 20-39" = "#FF6347",  # Tomato
#   "Vac 40-59" = "#DC143C",  # Crimson
#   "Vac >=60" = "#800000"  # Maroon
# )
# 
# combined_colors <- c(hybrid_colors, vac_colors)
# 
# ggsurv <- ggsurvplot(
#   fit = fit, 
#   data = data_Nstatus,
#   risk.table = TRUE,  
#   risk.table.col = "strata", 
#   risk.table.height = 0.25, 
#   risk.table.y.text.col = TRUE, 
#   risk.table.y.text = TRUE, 
#   ncensor.plot = TRUE,
#   ncensor.plot.height = 0.25, 
#   pval = TRUE,
#   conf.int = TRUE, 
#   palette = combined_colors,  # Use the combined color palette
#   legend.labs = c(
#     "Hybrid <20", "Hybrid 20-39", "Hybrid 40-59", "Hybrid >=60",
#     "Vac <20", "Vac 20-39", "Vac 40-59", "Vac >=60"
#   ),
#   xlab = "Months", 
#   ylab = "Overall Survival Probability",
#   break.time.by = 1,
#   ggtheme = theme_minimal() +
#     theme(
#       legend.position = "right",  # Position the legend
#       legend.text = element_text(size = 10),
#       legend.title = element_text(size = 1),
#       plot.margin = unit(c(1, 5, 1, 1), "cm"),
#       panel.border = element_rect(color = "black", fill = NA, size = 1)
#     ),
#   ylim = c(0.4, 1),  # Set y-axis limits, 
#   xlim = c(0, 4.5)
# )
# 
# p1 <- ggsurv$plot + 
#   scale_color_manual(values = combined_colors) +  # Apply the color palette
#   theme(
#     legend.position = c(0.08, 0.2),
#     legend.text = element_text(size = 10),  # Adjust legend text size
#     legend.title = element_text(size = 10),  # Adjust legend title size
#     legend.key.size = unit(0.5, "cm")  # Adjust legend key size
#   ) +
#   guides(colour = guide_legend(nrow = 2, byrow = TRUE, 
#                                title.position = "top",
#                                title.hjust = 0.5)) + 
#   ylab("Probability of Protective Effectiveness Against Infection") + 
#   theme(plot.margin = grid::unit(c(0, 0, 0, 0), "mm"))
# 
# ggsave("../result/plots/fig3(2).png", plot = p1, width = 10, height = 6, dpi = 200)


# ------------------------------------------------------------------------------
# cox-hazard regression model 
plot_logHR_tt_cox <- function(fit_tv_cox, data) {
  # Extract coefficients and variance-covariance matrix
  coef_vec <- coef(fit_tv_cox)
  vcov_mat <- vcov(fit_tv_cox)
  
  # Create time grid
  t_grid <- seq(0.1, max(data$time, na.rm = TRUE), length.out = 200)
  log_t <- log(t_grid)
  
  # Log-HR and variance for vac
  logHR_vac <- coef_vec["vac"] + coef_vec["tt(vac)"] * log_t
  var_logHR_vac <- vcov_mat["vac", "vac"] +
    log_t^2 * vcov_mat["tt(vac)", "tt(vac)"] +
    2 * log_t * vcov_mat["vac", "tt(vac)"]
  se_logHR_vac <- sqrt(var_logHR_vac)
  
  # Log-HR and variance for inf
  logHR_inf <- coef_vec["inf"] + coef_vec["tt(inf)"] * log_t
  var_logHR_inf <- vcov_mat["inf", "inf"] +
    log_t^2 * vcov_mat["tt(inf)", "tt(inf)"] +
    2 * log_t * vcov_mat["inf", "tt(inf)"]
  se_logHR_inf <- sqrt(var_logHR_inf)
  
  # Confidence intervals
  logHR_vac_low <- logHR_vac - 1.96 * se_logHR_vac
  logHR_vac_high <- logHR_vac + 1.96 * se_logHR_vac
  
  logHR_inf_low <- logHR_inf - 1.96 * se_logHR_inf
  logHR_inf_high <- logHR_inf + 1.96 * se_logHR_inf
  
  # Plot setup
  par(family = "serif", mar = c(5, 5, 1, 1), las = 1)
  plot(t_grid, logHR_vac, type = "n", 
       ylim = c(min(logHR_vac_low, logHR_inf_low), max(logHR_vac_high, logHR_inf_high)), 
       xlab = "Time (Months)", 
       ylab = "Log hazard ratio", 
       cex.lab = 1.4, cex.axis = 1.2)
  
  # Add grid lines
  grid(col = "lightgray", lty = "dotted", lwd = 0.8)
  
  # Confidence ribbons
  polygon(c(t_grid, rev(t_grid)),
          c(logHR_vac_low, rev(logHR_vac_high)),
          col = adjustcolor("forestgreen", alpha.f = 0.25), border = NA)
  
  polygon(c(t_grid, rev(t_grid)),
          c(logHR_inf_low, rev(logHR_inf_high)),
          col = adjustcolor("orange", alpha.f = 0.25), border = NA)
  
  # Log-HR lines
  lines(t_grid, logHR_vac, col = "forestgreen", lwd = 2)
  lines(t_grid, logHR_inf, col = "orange", lwd = 2, lty = 2)
  
  # Reference line
  abline(h = 0, col = "gray40", lty = 1, lwd = 1)
  
  # Legend
  legend("topright", 
         legend = c("Vaccine vs Hybrid", "Infection vs Hybrid"),
         col = c("forestgreen", "orange"), 
         lty = c(1, 2), 
         lwd = 2, 
         bty = "n", 
         cex = 1)
}


plot_HR_tt_cox <- function(fit_tv_cox, data) {
  # Extract coefficients and variance-covariance matrix
  coef_vec <- coef(fit_tv_cox)
  vcov_mat <- vcov(fit_tv_cox)
  
  # Create time grid
  t_grid <- seq(0.1, max(data$time, na.rm = TRUE), length.out = 200)
  log_t <- log(t_grid)
  
  # Log-HR and variance for vac
  logHR_vac <- coef_vec["vac"] + coef_vec["tt(vac)"] * log_t
  var_logHR_vac <- vcov_mat["vac", "vac"] +
    log_t^2 * vcov_mat["tt(vac)", "tt(vac)"] +
    2 * log_t * vcov_mat["vac", "tt(vac)"]
  se_logHR_vac <- sqrt(var_logHR_vac)
  
  # Log-HR and variance for inf
  logHR_inf <- coef_vec["inf"] + coef_vec["tt(inf)"] * log_t
  var_logHR_inf <- vcov_mat["inf", "inf"] +
    log_t^2 * vcov_mat["tt(inf)", "tt(inf)"] +
    2 * log_t * vcov_mat["inf", "tt(inf)"]
  se_logHR_inf <- sqrt(var_logHR_inf)
  
  # HRs and confidence intervals
  HR_vac <- exp(logHR_vac)
  HR_vac_lower <- exp(logHR_vac - 1.96 * se_logHR_vac)
  HR_vac_upper <- exp(logHR_vac + 1.96 * se_logHR_vac)
  
  HR_inf <- exp(logHR_inf)
  HR_inf_lower <- exp(logHR_inf - 1.96 * se_logHR_inf)
  HR_inf_upper <- exp(logHR_inf + 1.96 * se_logHR_inf)
  
  # Plot setup
  par(family = "serif", mar = c(4, 4, .5, .5))
  plot(t_grid, HR_vac, type = "n", 
       ylim = range(c(HR_vac_lower, HR_vac_upper, HR_inf_lower, HR_inf_upper)),
       xlab = "Months", ylab = "Hazard ratio", 
       cex.lab = 1.2, cex.axis = 1)
  
  # CI ribbons
  polygon(c(t_grid, rev(t_grid)),
          c(HR_vac_lower, rev(HR_vac_upper)),
          col = adjustcolor("forestgreen", alpha.f = 0.2), border = NA)
  
  polygon(c(t_grid, rev(t_grid)),
          c(HR_inf_lower, rev(HR_inf_upper)),
          col = adjustcolor("orange", alpha.f = 0.2), border = NA)
  
  # HR curves
  lines(t_grid, HR_vac, col = "forestgreen", lwd = 2)
  lines(t_grid, HR_inf, col = "orange", lwd = 2, lty = 2)
  
  # Reference line at HR = 1
  abline(h = 1, col = "gray40", lty = 1)
  
  # Legend
  legend("topright", legend = c("Vaccine vs Hybrid", "Infection vs Hybrid"),
         col = c("forestgreen", "orange"), lty = c(1, 2), lwd = 2, bty = "n", cex = 0.9)
}

extract_logHR_tt_cox <- function(fit_tv_cox, data) {
  # Extract coefficients and variance-covariance matrix
  coef_vec <- coef(fit_tv_cox)
  vcov_mat <- vcov(fit_tv_cox)
  
  # Create time grid
  t_grid <- seq(0.1, max(data$time, na.rm = TRUE), length.out = 200)
  log_t <- log(t_grid)
  
  # Log-HR and variance for vac
  logHR_vac <- coef_vec["vac"] + coef_vec["tt(vac)"] * log_t
  var_logHR_vac <- vcov_mat["vac", "vac"] +
                   log_t^2 * vcov_mat["tt(vac)", "tt(vac)"] +
                   2 * log_t * vcov_mat["vac", "tt(vac)"]
  se_logHR_vac <- sqrt(var_logHR_vac)
  
  # Log-HR and variance for inf
  logHR_inf <- coef_vec["inf"] + coef_vec["tt(inf)"] * log_t
  var_logHR_inf <- vcov_mat["inf", "inf"] +
                   log_t^2 * vcov_mat["tt(inf)", "tt(inf)"] +
                   2 * log_t * vcov_mat["inf", "tt(inf)"]
  se_logHR_inf <- sqrt(var_logHR_inf)
  
  # Build data frame
  data.frame(
    time = t_grid,
    logHR_vac = logHR_vac,
    logHR_vac_lower = logHR_vac - 1.96 * se_logHR_vac,
    logHR_vac_upper = logHR_vac + 1.96 * se_logHR_vac,
    logHR_inf = logHR_inf,
    logHR_inf_lower = logHR_inf - 1.96 * se_logHR_inf,
    logHR_inf_upper = logHR_inf + 1.96 * se_logHR_inf
  )
}

extract_HR_tt_cox <- function(fit_tv_cox, data) {
  # Extract coefficients and variance-covariance matrix
  coef_vec <- coef(fit_tv_cox)
  vcov_mat <- vcov(fit_tv_cox)
  
  # Create time grid
  t_grid <- seq(0.1, max(data$time, na.rm = TRUE), length.out = 200)
  log_t <- log(t_grid)
  
  # Log-HR and variance for vac
  logHR_vac <- coef_vec["vac"] + coef_vec["tt(vac)"] * log_t
  var_logHR_vac <- vcov_mat["vac", "vac"] +
    log_t^2 * vcov_mat["tt(vac)", "tt(vac)"] +
    2 * log_t * vcov_mat["vac", "tt(vac)"]
  se_logHR_vac <- sqrt(var_logHR_vac)
  
  # Log-HR and variance for inf
  logHR_inf <- coef_vec["inf"] + coef_vec["tt(inf)"] * log_t
  var_logHR_inf <- vcov_mat["inf", "inf"] +
    log_t^2 * vcov_mat["tt(inf)", "tt(inf)"] +
    2 * log_t * vcov_mat["inf", "tt(inf)"]
  se_logHR_inf <- sqrt(var_logHR_inf)
  
  # Return data frame with HRs
  data.frame(
    time = t_grid,
    HR_vac = exp(logHR_vac),
    HR_vac_lower = exp(logHR_vac - 1.96 * se_logHR_vac),
    HR_vac_upper = exp(logHR_vac + 1.96 * se_logHR_vac),
    HR_inf = exp(logHR_inf),
    HR_inf_lower = exp(logHR_inf - 1.96 * se_logHR_inf),
    HR_inf_upper = exp(logHR_inf + 1.96 * se_logHR_inf)
  )
}

library(ggsurvfit)
library(survminer)
library(survival)
library(flexsurv)

url <- list(
  N_status = "TempData/data_Nstatus.rds", 
  KDCA = "TempData/data_KDCA.rds"
)

# load data
data_Nstatus <- readRDS(url$N_status)
data_KDCA <- readRDS(url$KDCA)

data_KDCA$vac <- as.numeric(data_KDCA$immune_type == "vac-induced")
data_KDCA$inf <- as.numeric(data_KDCA$immune_type == "inf-induced")
data_KDCA$sex <- factor(data_KDCA$sex, 
                        levels = c("Male", "Female"))
data_KDCA$age_category <- factor(data_KDCA$age_category, 
                                 levels = c(">60", "<20", "20-40", "40-60"))


data_Nstatus$vac <- as.numeric(data_Nstatus$immune_type == "vac-induced")
data_Nstatus$inf <- as.numeric(data_Nstatus$immune_type == "inf-induced")
data_Nstatus$sex <- factor(data_Nstatus$sex, 
                           levels = c("Male", "Female"))
data_Nstatus$age_category <- factor(data_Nstatus$age_category, 
                                    levels = c(">60", "<20", "20-40", "40-60"))

fit_tv_cox_KDCA <- coxph(Surv(time, status) ~ vac + inf + age_category + sex +
                      tt(vac) + tt(inf),
                    data = data_KDCA,
                    weights = wgt_1ag,
                    tt = function(x, t, ...) x * log(t))

summary(fit_tv_cox_KDCA)
logHR_df <- extract_logHR_tt_cox(fit_tv_cox_KDCA, data_KDCA)

# Save plot to PNG
png("../result/plots/logHR_tt_cox_KDCA.png", width = 1800, height = 1200, res = 300)
plot_logHR_tt_cox(fit_tv_cox_KDCA, data_KDCA)
dev.off()




fit_tv_cox_Nstatus <- coxph(Surv(time, status) ~ vac + inf + age_category + sex +
                      tt(vac) + tt(inf),
                    data = data_Nstatus,
                    weights = wgt_1ag,
                    tt = function(x, t, ...) x * log(t))

summary(fit_tv_cox_Nstatus)
logHR_df <- extract_logHR_tt_cox(fit_tv_cox_Nstatus, data_Nstatus)

png("../result/plots/logHR_tt_cox_Nstatus.png", width = 1800, height = 1200, res = 300)
plot_logHR_tt_cox(fit_tv_cox_Nstatus, data_Nstatus)
dev.off()


```

## generate survival table 
```{r}

data_KDCA$num_diseases_S1

fit_cox <- coxph(Surv(time, status) ~ immune_type,
                 data = data_KDCA,
                 weights = wgt_1ag)
ph_test <- cox.zph(fit_cox)
print(ph_test)

fit_cox <- coxph(Surv(time, status) ~ immune_type + age_category + sex + vac_before_S1_freq + immune_type:age_category + immune_type:sex + immune_type:vac_before_S1_freq,
                 data = data_Nstatus,
                 weights = wgt_1ag)
ph_test <- cox.zph(fit_cox)
print(ph_test)

generate_survival_table <- function(data, grid) {
  survival_table <- matrix(nrow = length(grid) - 1, ncol = 6)
  colnames(survival_table) <- c("time", "n", "y", "l", "h", "S_hat")
  S_hat <- 1
  
  for (i in 1:(length(grid) - 1)) {
    start_time <- grid[i]
    end_time <- grid[i + 1]
    
    n_at_risk <- sum(data$time >= start_time)
    events <- sum(data$time >= start_time & data$time < end_time & data$status == 1)
    left_truncated <- sum(data$time >= start_time & data$time < end_time & data$status == 0)
    hazard <- ifelse(n_at_risk > 0, events / n_at_risk, 0)
    S_hat <- S_hat * (1 - hazard)
    
    survival_table[i, ] <- c(start_time, n_at_risk, events, left_truncated, hazard, S_hat)
  }
  
  survival_table <- as.data.frame(survival_table)
  colnames(survival_table) <- c("time", "n", "y", "l", "h", "S_hat")
  return(survival_table)
}
grid <- c(0, 1, 2, 3, 4, 5)

# re-level the data_KDCA and data_Nstatus
data_KDCA$age_category <- factor(data_KDCA$age_category, levels = c("<20", "20-40", "40-60", ">60"))
data_Nstatus$age_category <- factor(data_Nstatus$age_category, levels = c("<20", "20-40", "40-60", ">60"))

# define the function
age_risk_table <- function(df, age_selection = "no"){
  
  # Define the age categories and immune types
  age_categories <- c("<20", "20-40", "40-60", ">60")
  immune_types   <- c("hybrid-induced", "vac-induced")
  
  # List to store matrices for each immune type
  result_list <- list()
  
  # Loop over each immune type
  for (imm in immune_types) {
    if(age_selection == "yes"){
      # For each age category, generate the survival table for this immune type
      sub_list <- lapply(age_categories, function(age_cat) {
        df %>% 
          filter(immune_type == imm, age_category == age_cat) %>% 
          generate_survival_table(grid) %>% 
          mutate(feed = paste0(n, " (", y, ")")) %>% 
          select(feed) %>% 
          unlist()
      })
      # Combine the results for the current immune type into a matrix
      sub_matrix <- do.call(rbind, sub_list)
      # Name the rows as "immuneType_ageCategory"
      rownames(sub_matrix) <- paste(imm, age_categories, sep = "_")
    } else {
      # If age_selection is not "yes", ignore age category filter for this immune type
      sub_matrix <- df %>% 
        filter(immune_type == imm) %>% 
        generate_survival_table(grid) %>% 
        mutate(feed = paste0(n, " (", y, ")")) %>% 
        select(feed) %>% 
        unlist() %>% 
        matrix(nrow = 1)
      # Row name will be the immune type
      rownames(sub_matrix) <- imm
    }
    # Store the result for the current immune type
    result_list[[imm]] <- sub_matrix
  }
  
  # Combine results from both immune types
  result_matrix <- do.call(rbind, result_list)
  
  return(result_matrix)
}

# age_risk_table(data_Nstatus, age_selection = "no") %>% write.csv(file = "../risk_tabel.csv")

generate_survival_table(data_KDCA %>% filter(immune_type == "vac-induced"), grid = grid) 
# 
# data_vac <- matrix(c(
#   2502, 417,
#   2085, 193,
#   1892, 230,
#   1662, 119
# ), nrow = 4, byrow = TRUE)
# 
# data_inf <- matrix(c(
#   410, 44,
#   366, 21,
#   345, 26,
#   319, 6
# ), nrow = 4, byrow = TRUE)
# 
# data_hyb <- matrix(c(
#   3078, 91,
#   2987, 86,
#   2901, 243,
#   2658, 143
# ), nrow = 4, byrow = TRUE)
# 
# fisher.test(rbind(data_inf[1, ], data_hyb[1, ]))
```



# ----------------------------
# 1.Weighted proportional cox-hazard model (weighted)

```{r}
library(tibble)
data_KDCA$immune_type <- factor(data_KDCA$immune_type , levels = c("hybrid-induced", "vac-induced"))
data_KDCA$sex <- factor(data_KDCA$sex, levels = c("Male", "Female"))
data_KDCA$age_category <- factor(data_KDCA$age_category, levels = c("40-60", "<20", "20-40", ">60"))
# fit_KDCA <- coxph(Surv(time, status) ~ immune_type * (vac_before_S1_freq + age_category + sex),
#                   data = data_KDCA, 
#                   weights = wgt_1ag)
# fit_sum <- summary(fit_KDCA)
# cox.zph(fit_KDCA)

KDCA_hybrid <- coxph(Surv(time, status) ~ sex + age_category + vac_before_S1_freq, 
                     data = subset(data_KDCA, immune_type == "hybrid-induced"))
KDCA_vac    <- coxph(Surv(time, status) ~ sex + age_category + vac_before_S1_freq,
                     data = subset(data_KDCA, immune_type == "vac-induced"))
summary(KDCA_hybrid)
summary(KDCA_vac)

cox.zph(KDCA_hybrid)
cox.zph(KDCA_vac)

KDCA_combined <- coxph(Surv(time, status) ~ 
                          sex * immune_type + 
                          age_category * immune_type + 
                          vac_before_S1_freq * immune_type, 
                        data = data_KDCA)
cox.zph(KDCA_combined)



# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------
data_Nstatus$sex <- factor(data_Nstatus$sex, levels = c("Male", "Female"))
data_Nstatus$immune_type <- factor(data_Nstatus$immune_type , levels = c("hybrid-induced", "vac-induced"))
data_Nstatus$age_category <- factor(data_Nstatus$age_category, levels = c("40-60", "<20", "20-40", ">60"))
# fit_Nstatus <- coxph(Surv(time, status) ~ immune_type * (vac_before_S1_freq + age_category + sex),
#                   data = data_Nstatus,
#                   weights = wgt_1ag)
# 
# cox.zph(fit_Nstatus)
Nstatus_hybrid <- coxph(Surv(time, status) ~ sex + age_category + vac_before_S1_freq, 
                     data = subset(data_Nstatus, immune_type == "hybrid-induced"))
Nstatus_vac    <- coxph(Surv(time, status) ~ sex + age_category + vac_before_S1_freq,
                     data = subset(data_Nstatus, immune_type == "vac-induced"))
summary(Nstatus_hybrid)
summary(Nstatus_vac)

cox.zph(Nstatus_hybrid)
cox.zph(Nstatus_vac)

Nstatus_combined <- coxph(Surv(time, status) ~ 
                          sex * immune_type + 
                          age_category * immune_type + 
                          vac_before_S1_freq * immune_type, 
                        data = data_Nstatus)
cox.zph(Nstatus_combined)
```

